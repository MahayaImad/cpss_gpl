<?xml version="1.0" encoding="utf-8"?>
<odoo>
    <!-- FORMULAIRE GPL RESERVOIR TESTING - Style Inspections -->
    <record id="view_gpl_reservoir_testing_form" model="ir.ui.view">
        <field name="name">gpl.reservoir.testing.form</field>
        <field name="model">gpl.reservoir.testing</field>
        <field name="arch" type="xml">
            <form string="Réépreuve Réservoir GPL">
                <header>
                    <button name="action_plan" string="Planifier" type="object"
                            class="btn-primary" invisible="state != 'draft'"/>
                    <button name="action_start" string="Commencer le test" type="object"
                            class="btn-primary" invisible="state not in ('draft', 'planned')"/>

                    <!-- Actions de validation comme inspections -->
                    <button name="action_validate_pass" string="Valider - CONFORME" type="object"
                            class="btn-success" invisible="state != 'in_progress'"/>
                    <button name="action_validate_fail" string="Terminer - NON CONFORME" type="object"
                            class="btn-danger" invisible="state != 'in_progress'"/>

                    <button name="action_cancel" string="Annuler" type="object"
                            invisible="state == 'done'"/>
                    <button name="action_reset_to_draft" string="Remettre en brouillon" type="object"
                            invisible="state not in ('planned', 'cancel')"/>

                    <!-- Impression certificat -->
                    <button name="action_print_certificate" string="Imprimer Certificat" type="object"
                            class="btn-secondary" invisible="state != 'done' or result != 'pass'"/>

                    <field name="state" widget="statusbar" statusbar_visible="draft,planned,in_progress,done"/>
                </header>

                <sheet>
                    <!-- En-tête avec résultat -->
                    <div class="oe_button_box" name="button_box">
                        <!--<button name="action_print_certificate" type="object" class="oe_stat_button"
                                icon="fa-certificate"
                                invisible="state != 'done' or result != 'pass'">
                            <div class="o_field_widget o_stat_info">
                                <span class="o_stat_text">Certificat</span>
                            </div>
                        </button> -->

                        <button class="oe_stat_button" icon="fa-percent" invisible="state != 'done'">
                            <field name="conformity_percentage" class="o_stat_value" widget="integer"/>
                            <span class="o_stat_text">% Conformité</span>
                        </button>
                    </div>

                    <div class="oe_title">
                        <h1>
                            <field name="name" readonly="1"/>
                        </h1>
                        <div class="o_row" name="title">
                            <h2>
                                <field name="test_type" readonly="state == 'done'"/>
                                <span invisible="state != 'done'"> - </span>
                                <field name="result" invisible="state != 'done'"
                                       decoration-success="result == 'pass'"
                                       decoration-danger="result == 'fail'"
                                       decoration-warning="result == 'pending'"/>
                            </h2>
                        </div>
                    </div>

                    <group>
                        <group name="general_info" string="Informations Générales">
                            <field name="date_start" readonly="state == 'done'"/>
                            <field name="date_planned" readonly="state == 'done'"/>
                        </group>

                        <group name="reservoir_info" string="Réservoir">
                            <field name="reservoir_lot_id" readonly="state == 'done'"
                                   options="{'no_create': True}"/>
                            <field name="reservoir_serial"/>
                            <field name="fabrication_date"/>
                            <field name="next_test_date" invisible="state != 'done'"/>
                        </group>
                    </group>

                    <group>
                        <group name="vehicle_info" string="Véhicule et Client">
                            <field name="vehicle_id" readonly="state == 'done'"
                                   options="{'no_create': True}"/>
                            <field name="client_id"/>
                        </group>

                        <group name="certificate_info" string="Certificat" invisible="state != 'done'">
                            <field name="certificate_number"/>
                            <field name="certificate_date"/>
                            <field name="test_passed" invisible="1"/>
                        </group>
                    </group>

                    <!-- NOTEBOOK - Tests et Résultats comme inspections -->
                    <notebook>
                        <!-- Page 1: Tests et Vérifications -->
                        <page string="Tests et Vérifications" name="tests">

                            <group readonly="state != 'in_progress'">
                                <!-- Section A: Inspection Visuelle -->
                                <group string="A. INSPECTION VISUELLE">
                                    <field name="visual_inspection_ok"
                                           decoration-success="visual_inspection_ok == True"
                                           decoration-danger="visual_inspection_ok == False"
                                           readonly="state == 'done'" invisible="1"/>

                                    <field name="reservoir_external_ok" string="État externe"
                                           readonly="state == 'done'"/>
                                    <field name="reservoir_marking_ok" string="Marquage conforme"
                                           readonly="state == 'done'"/>
                                    <field name="reservoir_fixation_ok" string="Fixation correcte"
                                           readonly="state == 'done'"/>
                                    <field name="reservoir_support_ok" string="Support adapté"
                                           readonly="state == 'done'"/>

                                    <field name="visual_notes" string="Observations"
                                           placeholder="Notes sur l'inspection visuelle..."
                                           readonly="state == 'done'"/>

                                    <button name="action_mark_all_visual_ok" string="✓ Marquer tout conforme"
                                            type="object" class="btn-sm btn-success"
                                            invisible="state == 'done'"/>

                                </group>

                                <!-- Section B: Test de Pression -->
                                <group string="B. TEST DE PRESSION">

                                    <field name="pressure_test_ok"
                                           decoration-success="pressure_test_ok == True"
                                           decoration-danger="pressure_test_ok == False"
                                           readonly="state == 'done'" invisible="1"/>

                                        <group string="Paramètres">
                                            <field name="test_pressure" readonly="state == 'done'"/>
                                            <field name="test_duration" readonly="state == 'done'"/>
                                            <field name="ambient_temperature" readonly="state == 'done'"/>
                                        </group>
                                        <group string="Mesures">
                                            <field name="initial_pressure" readonly="state == 'done'"/>
                                            <field name="final_pressure" readonly="state == 'done'"/>
                                            <field name="pressure_drop" readonly="1"/>
                                        </group>


                                    <field name="pressure_notes" string="Observations"
                                           placeholder="Notes sur le test de pression..."
                                           readonly="state == 'done'"/>

                                    <group>
                                        <button name="action_mark_all_pressure_ok" string="✓ Marquer Test réussi"
                                            type="object" class="btn-sm btn-success"
                                            invisible="state == 'done'"/>

                                    </group>

                                </group>

                            </group>

                            <separator/>

                            <group readonly="state != 'in_progress'">
                                <field name="state"/>
                                 <!-- Section C: Test d'Étanchéité -->
                                <group string="C. TEST D'ÉTANCHÉITÉ">

                                    <field name="tightness_test_ok"
                                           decoration-success="tightness_test_ok == True"
                                           decoration-danger="tightness_test_ok == False"
                                           readonly="state == 'done'" invisible="1"/>

                                    <field name="valve_tightness_ok" string="Vanne" readonly="state == 'done'"/>
                                    <field name="fitting_tightness_ok" string="Raccords"
                                           readonly="state == 'done'"/>
                                    <field name="weld_tightness_ok" string="Soudures" readonly="state == 'done'"/>
                                    <field name="humidity" readonly="state == 'done'"/>

                                    <field name="tightness_notes" string="Observations"
                                           placeholder="Notes sur les tests d'étanchéité..."
                                           readonly="state == 'done'"/>

                                    <button name="action_mark_all_tightness_ok" string="✓ Marquer tout étanche"
                                            type="object" class="btn-sm btn-success"
                                            invisible="state == 'done'"/>

                                </group>

                                <!-- Section D: Systèmes de Sécurité -->
                                <group string="D. SYSTÈMES DE SÉCURITÉ">

                                    <field name="safety_systems_ok"
                                           decoration-success="safety_systems_ok == True"
                                           decoration-danger="safety_systems_ok == False"
                                           readonly="state == 'done'" invisible="1"/>

                                    <field name="safety_notes" string="Observations"
                                           placeholder="Notes sur les systèmes de sécurité..."
                                           readonly="state == 'done'"/>

                                    <button name="action_mark_all_safety_ok" string="✓ Sécurité conforme"
                                            type="object" class="btn-sm btn-success"
                                            invisible="state == 'done'"/>
                                </group>

                            </group>

                            <separator/>

                        </page>

                        <!-- Page 2: Résultats et Actions -->
                        <page string="Résultats et Actions" name="results">
                            <group>
                                <group string="Résultat Final" name="final_result">
                                    <field name="result" readonly="1"
                                           decoration-success="result == 'pass'"
                                           decoration-danger="result == 'fail'"
                                           decoration-warning="result == 'pending'"/>
                                    <field name="conformity_percentage" readonly="1"/>
                                    <field name="test_passed" invisible="1"/>
                                </group>

                                <group string="Suivi" name="follow_up" invisible="state != 'done'">
                                    <field name="certificate_number"/>
                                    <field name="certificate_date"/>
                                    <field name="next_test_date"/>
                                </group>
                            </group>

                            <separator string="Observations et Actions"/>

                            <group>
                                <field name="notes" string="Observations générales"
                                       placeholder="Remarques générales sur le test..."
                                       readonly="state == 'done'"/>
                            </group>

                            <group invisible="result != 'fail'">
                                <field name="corrective_actions" string="Actions correctives nécessaires"
                                       placeholder="Actions à entreprendre pour la conformité..."
                                       readonly="state == 'done'"/>
                            </group>

                            <group>
                                <field name="recommendations" string="Recommandations"
                                       placeholder="Recommandations pour l'avenir..."
                                       readonly="state == 'done'"/>
                            </group>
                        </page>

                        <!-- Page 3: Personnel -->
                        <page string="Personnel" name="staff">
                            <group string="Équipe de Test">
                                <field name="technician_ids" readonly="state == 'done'"
                                       widget="many2many_tags"/>
                            </group>
                        </page>
                    </notebook>
                </sheet>

                <!-- Chatter -->
                <div class="oe_chatter">
                    <field name="message_follower_ids"/>
                    <field name="activity_ids"/>
                    <field name="message_ids"/>
                </div>
            </form>
        </field>
    </record>

    <!-- VUE LISTE GPL RESERVOIR TESTING -->
    <record id="view_gpl_reservoir_testing_tree" model="ir.ui.view">
        <field name="name">gpl.reservoir.testing.tree</field>
        <field name="model">gpl.reservoir.testing</field>
        <field name="arch" type="xml">
            <tree string="Réépreuves Réservoirs GPL"
                  decoration-success="result == 'pass'"
                  decoration-danger="result == 'fail'"
                  decoration-warning="result == 'pending'"
                  decoration-muted="state == 'cancel'">

                <field name="name"/>
                <field name="date_start"/>
                <field name="test_type"/>
                <field name="reservoir_serial"/>
                <field name="vehicle_id" optional="show"/>
                <field name="client_id" optional="show"/>

                <!-- Résultats principaux -->
                <field name="visual_inspection_ok" widget="boolean" optional="hide"/>
                <field name="pressure_test_ok" widget="boolean" optional="hide"/>
                <field name="tightness_test_ok" widget="boolean" optional="hide"/>
                <field name="safety_systems_ok" widget="boolean" optional="hide"/>

                <!-- Résultat final -->
                <field name="conformity_percentage" widget="float" optional="show"/>
                <field name="result"
                       decoration-success="result == 'pass'"
                       decoration-danger="result == 'fail'"
                       decoration-warning="result == 'pending'"/>

                <field name="state" widget="badge"
                       decoration-success="state == 'done'"
                       decoration-info="state in ('planned', 'in_progress')"
                       decoration-muted="state in ('draft', 'cancel')"/>

                <field name="certificate_number" optional="hide"/>
                <field name="next_test_date" optional="hide"/>
            </tree>
        </field>
    </record>

    <!-- VUE KANBAN GPL RESERVOIR TESTING -->
    <record id="view_gpl_reservoir_testing_kanban" model="ir.ui.view">
        <field name="name">gpl.reservoir.testing.kanban</field>
        <field name="model">gpl.reservoir.testing</field>
        <field name="arch" type="xml">
            <kanban default_group_by="state"
                    class="o_kanban_small_column"
                    quick_create="false"
                    sample="1">

                <!-- Champs nécessaires -->
                <field name="state"/>
                <field name="result"/>
                <field name="name"/>
                <field name="date_start"/>
                <field name="test_type"/>
                <field name="reservoir_serial"/>
                <field name="vehicle_id"/>
                <field name="client_id"/>
                <field name="conformity_percentage"/>
                <field name="certificate_number"/>
                <field name="inspector_id"/>

                <!-- Progressbar -->
                <progressbar field="state"
                             colors='{"draft": "muted", "planned": "info", "in_progress": "warning", "done": "success", "cancel": "danger"}'/>

                <templates>
                    <t t-name="kanban-box">
                        <div t-attf-class="oe_kanban_global_click oe_kanban_card"
                             t-attf-style="border-left: 5px solid #{
                                record.result.raw_value == 'pass' ? '#28a745' :
                                record.result.raw_value == 'fail' ? '#dc3545' : '#ffc107'};">

                            <!-- Menu dropdown -->
                            <div class="o_dropdown_kanban dropdown position-absolute top-0 end-0">
                                <a class="dropdown-toggle o-no-caret btn" role="button" data-bs-toggle="dropdown"
                                   href="#" title="Menu">
                                    <span class="fa fa-ellipsis-v"/>
                                </a>
                                <div class="dropdown-menu dropdown-menu-end" role="menu">
                                    <a role="menuitem" type="edit" class="dropdown-item">Modifier</a>
                                    <a role="menuitem" type="delete" class="dropdown-item">Supprimer</a>
                                </div>
                            </div>

                            <!-- Card Body -->
                            <div class="oe_kanban_content p-2">
                                <!-- Header avec icône -->
                                <div class="d-flex align-items-center mb-2">
                                    <div class="me-2">
                                        <i class="fa fa-flask fa-2x text-warning" title="Test Réservoir"/>
                                    </div>
                                    <div class="flex-grow-1">
                                        <strong class="o_kanban_record_title">
                                            <field name="name"/>
                                        </strong>
                                        <br/>
                                        <small class="text-muted">
                                            <field name="test_type"/>
                                        </small>
                                    </div>
                                </div>

                                <!-- Badge résultat -->
                                <div class="mb-2" t-if="record.result.raw_value != 'pending'">
                                    <span t-attf-class="badge text-white #{
                                        record.result.raw_value == 'pass' ? 'bg-success' :
                                        record.result.raw_value == 'fail' ? 'bg-danger' : 'bg-warning'}">
                                        <i t-attf-class="fa #{
                                            record.result.raw_value == 'pass' ? 'fa-check' :
                                            record.result.raw_value == 'fail' ? 'fa-times' : 'fa-clock-o'} me-1" title="result"/>
                                        <span t-if="record.result.raw_value == 'pass'">VALIDÉ</span>
                                        <span t-elif="record.result.raw_value == 'fail'">ÉCHEC</span>
                                        <span t-else="">EN COURS</span>
                                    </span>
                                </div>

                                <!-- Informations principales -->
                                <div class="d-flex flex-column mb-2">
                                    <!-- Réservoir -->
                                    <div class="mb-1" t-if="record.reservoir_serial.raw_value">
                                        <i class="fa fa-barcode text-primary me-2" title="reservoir"/>
                                        <strong><field name="reservoir_serial"/></strong>
                                    </div>

                                    <!-- Véhicule -->
                                    <div class="mb-1" t-if="record.vehicle_id.raw_value">
                                        <i class="fa fa-car text-info me-2" title="car"/>
                                        <span><field name="vehicle_id"/></span>
                                    </div>

                                    <!-- Client
                                    <div class="mb-1" t-if="record.client_id.raw_value">
                                        <i class="fa fa-user text-muted me-2"/>
                                        <small><field name="client_id"/></small>
                                    </div>-->

                                    <!-- Conformité -->
                                    <div class="mb-1" t-if="record.conformity_percentage.raw_value > 0">
                                        <div class="progress" style="height: 6px;">
                                            <div t-attf-class="progress-bar #{
                                                record.conformity_percentage.raw_value >= 80 ? 'bg-success' :
                                                record.conformity_percentage.raw_value >= 60 ? 'bg-warning' : 'bg-danger'}"
                                                 t-attf-style="width: #{record.conformity_percentage.raw_value}%"/>
                                        </div>
                                        <small class="text-muted">
                                            Conformité: <field name="conformity_percentage"/> %
                                        </small>
                                    </div>

                                </div>

                                <!-- Footer -->
                                <div class="d-flex justify-content-between align-items-center">
                                    <div t-if="record.date_start.raw_value">
                                        <small class="text-muted">
                                            <i class="fa fa-calendar me-1" title="footer"/>
                                            <field name="date_start"/>
                                        </small>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </t>
                </templates>
            </kanban>
        </field>
    </record>

    <!-- VUE RECHERCHE GPL RESERVOIR TESTING -->
    <record id="view_gpl_reservoir_testing_search" model="ir.ui.view">
        <field name="name">gpl.reservoir.testing.search</field>
        <field name="model">gpl.reservoir.testing</field>
        <field name="arch" type="xml">
            <search string="Rechercher Réépreuves">
                <!-- Champs de recherche -->
                <field name="name" string="Référence"/>
                <field name="reservoir_serial" string="N° Série Réservoir"/>
                <field name="vehicle_id" string="Véhicule"/>
                <field name="client_id" string="Client"/>

                <!-- Filtres -->
                <filter string="Aujourd'hui" name="today"
                        domain="[('date_start', '=', context_today())]"/>
                <filter string="Cette semaine" name="this_week"
                        domain="[('date_start', '&gt;=', (datetime.date.today() - datetime.timedelta(days=datetime.date.today().weekday())).strftime('%Y-%m-%d'))]"/>
                <filter string="Ce mois" name="this_month"
                        domain="[('date_start', '&gt;=', time.strftime('%Y-%m-01'))]"/>

                <separator/>

                <!-- Filtres par état -->
                <filter string="Brouillon" name="draft"
                        domain="[('state', '=', 'draft')]"/>
                <filter string="Planifiés" name="planned"
                        domain="[('state', '=', 'planned')]"/>
                <filter string="En cours" name="in_progress"
                        domain="[('state', '=', 'in_progress')]"/>
                <filter string="Terminés" name="done"
                        domain="[('state', '=', 'done')]"/>

                <separator/>

                <!-- Filtres par résultat -->
                <filter string="Conformes" name="passed"
                        domain="[('result', '=', 'pass')]"/>
                <filter string="Non conformes" name="failed"
                        domain="[('result', '=', 'fail')]"/>
                <filter string="En attente" name="pending"
                        domain="[('result', '=', 'pending')]"/>

                <separator/>

                <!-- Filtres par type -->
                <filter string="Réépreuve périodique" name="periodic"
                        domain="[('test_type', '=', 'periodic')]"/>
                <filter string="Épreuve initiale" name="initial"
                        domain="[('test_type', '=', 'initial')]"/>
                <filter string="Réépreuve exceptionnelle" name="exceptional"
                        domain="[('test_type', '=', 'exceptional')]"/>

                <!-- Groupes -->
                <group expand="1" string="Grouper par">
                    <filter string="État" name="group_state" context="{'group_by': 'state'}"/>
                    <filter string="Résultat" name="group_result" context="{'group_by': 'result'}"/>
                    <filter string="Type de test" name="group_test_type" context="{'group_by': 'test_type'}"/>
                    <filter string="Client" name="group_client" context="{'group_by': 'client_id'}"/>
                    <filter string="Date" name="group_date" context="{'group_by': 'date_start:month'}"/>
                </group>
            </search>
        </field>
    </record>

    <!-- ACTION WINDOW GPL RESERVOIR TESTING -->
    <record id="action_gpl_reservoir_testing" model="ir.actions.act_window">
        <field name="name">Réépreuves Réservoirs GPL</field>
        <field name="res_model">gpl.reservoir.testing</field>
        <field name="view_mode">kanban,tree,form</field>
        <field name="view_ids" eval="[(5, 0, 0),
                                       (0, 0, {'view_mode': 'kanban', 'view_id': ref('view_gpl_reservoir_testing_kanban')}),
                                       (0, 0, {'view_mode': 'tree', 'view_id': ref('view_gpl_reservoir_testing_tree')}),
                                       (0, 0, {'view_mode': 'form', 'view_id': ref('view_gpl_reservoir_testing_form')})]"/>
        <field name="search_view_id" ref="view_gpl_reservoir_testing_search"/>
        <field name="help" type="html">
            <p class="o_view_nocontent_smiling_face">
                Créer une nouvelle réépreuve de réservoir GPL
            </p>
            <p>
                Les réépreuves permettent de vérifier la conformité et la sécurité
                des réservoirs GPL selon les normes en vigueur.
            </p>
            <p>
                Chaque test comprend une inspection visuelle, un test de pression,
                un contrôle d'étanchéité et une vérification des systèmes de sécurité.
            </p>
        </field>
        <field name="context">{
            'search_default_this_month': 1
        }</field>
    </record>

</odoo>
